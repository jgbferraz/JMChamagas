@page "/"
@layout JMChamagas.Web.Components.Layout.LoginLayout
@inject NavigationManager Navigation

<PageTitle>Login</PageTitle>

<div class="container mt-5" style="max-width: 520px;">
    <h1>JMChamagas</h1>
    <p class="text-muted">Acesso ao sistema</p>

    @if (!string.IsNullOrWhiteSpace(erro))
    {
        <div class="alert alert-danger" role="alert">@erro</div>
    }

    <form method="post" action="/login">
        <input type="hidden" name="returnUrl" value="@returnUrl" />

        <div class="mb-3">
            <label class="form-label">Usuário</label>
            <input class="form-control" name="username" autocomplete="username" />
        </div>

        <div class="mb-3">
            <label class="form-label">Senha</label>
            <input class="form-control" type="password" name="password" autocomplete="current-password" />
        </div>

        <div class="d-grid">
            <button type="submit" class="btn btn-primary">Entrar</button>
        </div>
    </form>
</div>

@code {
    private string? erro;
    private string returnUrl = "/resumovendas";

    protected override void OnInitialized()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);

        var query = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);

        if (query.TryGetValue("ReturnUrl", out var ru) && ru.Count > 0)
        {
            var candidate = ru[0];
            if (!string.IsNullOrWhiteSpace(candidate) && Uri.IsWellFormedUriString(candidate, UriKind.Relative))
                returnUrl = candidate;
        }

        if (query.TryGetValue("error", out var error) && error.Count > 0)
        {
            erro = "Usuário ou senha inválidos.";
        }
    }
}